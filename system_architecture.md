# System Architecture Document
## Area Screenshot & Clipboard Manager for Linux

**Version:** 1.0  
**Last Updated:** February 7, 2026  
**Architecture Type:** Event-Driven, Multi-Threaded Daemon

---

## 1. Executive Summary

This document describes the system architecture for a Linux-native screenshot and clipboard history manager. The system is designed as a single-daemon process that:
- Runs continuously in the background
- Monitors keyboard shortcuts and clipboard changes
- Provides instant UI responses via GTK
- Persists data to SQLite
- Maintains low resource usage (<50MB RAM)

**Key Architectural Principles:**
- **Modularity:** Clear separation of concerns
- **Performance:** Asynchronous operations where possible
- **Reliability:** Graceful error handling and recovery
- **Simplicity:** Minimal dependencies, straightforward data flows

---

## 2. High-Level Architecture

### 2.1 System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER SPACE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   Firefox    â”‚         â”‚    GIMP      â”‚                    â”‚
â”‚  â”‚  (Paste Dst) â”‚         â”‚ (Paste Dst)  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                        â”‚                             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                      â”‚                                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚  X11 CLIPBOARD  â”‚                                â”‚
â”‚              â”‚   (CLIPBOARD)   â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚         â”‚            â”‚            â”‚                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                       â”‚
â”‚    â”‚ Monitor â”‚  â”‚  Set   â”‚  â”‚   Get   â”‚                       â”‚
â”‚    â”‚ Changes â”‚  â”‚ Image  â”‚  â”‚ Content â”‚                       â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚           â”‚           â”‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚           â”‚           â”‚  CLIPBOARD-CAPTURE DAEMON    â”‚
â”‚         â”‚           â”‚           â”‚                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                        â”‚
â”‚    â”‚    Clipboard Manager Module       â”‚                        â”‚
â”‚    â”‚  (Arboard + Monitoring Thread)    â”‚                        â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”‚ Store History                                         â”‚
â”‚         â”‚                                                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚    â”‚      Database Layer (SQLite)      â”‚                        â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                        â”‚
â”‚    â”‚  â”‚ Images   â”‚     â”‚    Text     â”‚ â”‚                        â”‚
â”‚    â”‚  â”‚(PNG blob)â”‚     â”‚ (UTF-8 text)â”‚ â”‚                        â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚    â”‚   Global Hotkey Manager          â”‚                         â”‚
â”‚    â”‚   (global-hotkey crate)          â”‚                         â”‚
â”‚    â”‚                                  â”‚                         â”‚
â”‚    â”‚  Ctrl+Win+S â†’ Screenshot         â”‚                         â”‚
â”‚    â”‚  Win+H â†’ History Dialog          â”‚                         â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚         â”‚              â”‚                                        â”‚
â”‚         â”‚              â”‚                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚    â”‚ Screenshot  â”‚  â”‚ History Dialog â”‚                         â”‚
â”‚    â”‚   Module    â”‚  â”‚   (GTK4 UI)    â”‚                         â”‚
â”‚    â”‚             â”‚  â”‚                â”‚                         â”‚
â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                         â”‚
â”‚    â”‚ â”‚ Overlay â”‚ â”‚  â”‚ â”‚   Search   â”‚ â”‚                         â”‚
â”‚    â”‚ â”‚ Window  â”‚ â”‚  â”‚ â”‚ Thumbnails â”‚ â”‚                         â”‚
â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚  Restore   â”‚ â”‚                         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                         â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      X11 DISPLAY SERVER                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Screen Capture (XGetImage) â”‚ Window Management â”‚ Events        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Component Responsibilities

| Component | Responsibility | Technology |
|-----------|---------------|------------|
| **Daemon Process** | Main event loop, lifecycle management | Tokio async runtime |
| **Hotkey Manager** | Register and dispatch keyboard shortcuts | global-hotkey |
| **Screenshot Module** | Area selection, screen capture, encoding | XCB, image crate |
| **Clipboard Manager** | Clipboard operations, change monitoring | Arboard |
| **Database Layer** | Persistent storage, queries | SQLite (rusqlite) |
| **History Dialog** | User interface for browsing history | GTK 4 |
| **Config Manager** | Load/save configuration | TOML parser |
| **Notification System** | User feedback | notify-rust |

---

## 3. Component Architecture

### 3.1 Daemon Process (Main Controller)

**File:** `src/main.rs`

**Responsibilities:**
1. Initialize all subsystems
2. Run main event loop
3. Coordinate between components
4. Handle shutdown gracefully

**Process Lifecycle:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   System Boot    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load Config     â”‚
â”‚  (~/.config/     â”‚
â”‚  clipboard-      â”‚
â”‚  capture/)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Initialize DB   â”‚
â”‚  Create tables   â”‚
â”‚  if needed       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connect to X11  â”‚
â”‚  Get screen info â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Register Global  â”‚
â”‚    Hotkeys       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Start Clipboard  â”‚
â”‚    Monitor       â”‚
â”‚   (background    â”‚
â”‚     thread)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Initialize GTK  â”‚
â”‚  Application     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   EVENT LOOP     â•‘
â•‘                  â•‘
â•‘ â€¢ Hotkey events  â•‘
â•‘ â€¢ GTK events     â•‘
â•‘ â€¢ System signals â•‘
â•šâ•â•â•â•â•â•â•â•â”¬â•â•â•â•â•â•â•â•â•â•
         â”‚
         â”‚ (Ctrl+C or SIGTERM)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cleanup:        â”‚
â”‚  â€¢ Close DB      â”‚
â”‚  â€¢ Stop threads  â”‚
â”‚  â€¢ Release X11   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Exit        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Thread Model:**

```
Main Thread (GTK)
â”œâ”€ Event Loop
â”‚  â”œâ”€ Hotkey dispatcher
â”‚  â”œâ”€ GTK UI events
â”‚  â””â”€ Shutdown signals
â”‚
Background Threads
â”œâ”€ Clipboard Monitor Thread
â”‚  â””â”€ Polls clipboard every 500ms
â”‚
Tokio Task Pool
â”œâ”€ Screenshot capture task
â”œâ”€ Database operations
â””â”€ Async I/O operations
```

---

### 3.2 Screenshot Module

**Files:** `src/screenshot.rs`, `src/ui/overlay.rs`

**Architecture:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Screenshot Module                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   ScreenshotCapture (X11 Connection)     â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  â€¢ connect_to_x11()                     â”‚ â”‚
â”‚  â”‚  â€¢ get_screen_geometry()                â”‚ â”‚
â”‚  â”‚  â€¢ capture_region(x, y, w, h)          â”‚ â”‚
â”‚  â”‚  â€¢ encode_png(pixels)                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    SelectionOverlay (User Interaction)   â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  â€¢ create_transparent_window()          â”‚ â”‚
â”‚  â”‚  â€¢ dim_background()                     â”‚ â”‚
â”‚  â”‚  â€¢ handle_mouse_events()                â”‚ â”‚
â”‚  â”‚  â€¢ draw_selection_rectangle()           â”‚ â”‚
â”‚  â”‚  â€¢ show_dimensions_label()              â”‚ â”‚
â”‚  â”‚  â€¢ return_selected_area()               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    ImageProcessor                        â”‚ â”‚
â”‚  â”‚                                          â”‚ â”‚
â”‚  â”‚  â€¢ encode_to_png(rgba_data)             â”‚ â”‚
â”‚  â”‚  â€¢ create_thumbnail(png_bytes, 150px)   â”‚ â”‚
â”‚  â”‚  â€¢ convert_format(bgr â†’ rgba)           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Data Flow: Screenshot Capture**

```
User Presses Ctrl+Win+S
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hotkey Manager    â”‚
â”‚  dispatches event  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create Overlay    â”‚
â”‚  Window (X11)      â”‚
â”‚                    â”‚
â”‚  â€¢ Fullscreen      â”‚
â”‚  â€¢ Transparent     â”‚
â”‚  â€¢ Override WM     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dim Background    â”‚
â”‚  (50% black alpha) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wait for Mouse    â”‚
â”‚  Events            â”‚
â”‚                    â”‚
â”‚  â€¢ Button Press    â”‚
â”‚  â€¢ Motion          â”‚
â”‚  â€¢ Button Release  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (User drags)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Draw Selection    â”‚
â”‚  Rectangle         â”‚
â”‚                    â”‚
â”‚  â€¢ Blue border     â”‚
â”‚  â€¢ Semi-trans fill â”‚
â”‚  â€¢ Dimensions labelâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (User releases)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Get Rectangle     â”‚
â”‚  Coordinates       â”‚
â”‚  (x, y, w, h)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Destroy Overlay   â”‚
â”‚  Window            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Capture Screen    â”‚
â”‚  Region via XCB    â”‚
â”‚                    â”‚
â”‚  xcb::get_image()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Convert Pixels    â”‚
â”‚  BGR/BGRA â†’ RGBA   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Encode to PNG     â”‚
â”‚  (image crate)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generate          â”‚
â”‚  Thumbnail         â”‚
â”‚  (150x150 max)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Copy to Clipboard â”‚
â”‚  (Clipboard Mgr)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Store in Database â”‚
â”‚  (full PNG + thumb)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Show Notification â”‚
â”‚  "Screenshot saved"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**X11 Technical Details:**

```rust
// Overlay Window Creation
xcb::create_window(
    connection,
    screen.root_depth(),
    window_id,
    screen.root(),
    0, 0,                          // Position: top-left
    screen.width_in_pixels(),       // Full width
    screen.height_in_pixels(),      // Full height
    0,                             // Border width
    xcb::WINDOW_CLASS_INPUT_OUTPUT,
    screen.root_visual(),
    &[
        (xcb::CW_BACK_PIXEL, 0x000000),           // Black background
        (xcb::CW_OVERRIDE_REDIRECT, 1),            // Bypass WM
        (xcb::CW_EVENT_MASK,
            xcb::EVENT_MASK_EXPOSURE |
            xcb::EVENT_MASK_BUTTON_PRESS |
            xcb::EVENT_MASK_BUTTON_RELEASE |
            xcb::EVENT_MASK_POINTER_MOTION |
            xcb::EVENT_MASK_KEY_PRESS),
    ],
);

// Screen Capture
let cookie = xcb::get_image(
    connection,
    xcb::IMAGE_FORMAT_Z_PIXMAP,
    screen.root(),
    x, y, w, h,                    // Region to capture
    !0,                            // All bit planes
);
let reply = cookie.get_reply()?;
let raw_pixels = reply.data();
```

**Multi-Monitor Handling:**

```rust
// Query RandR for monitor layout
let randr_cookie = xcb::randr::get_screen_resources(connection, screen.root());
let randr_reply = randr_cookie.get_reply()?;

for crtc in randr_reply.crtcs() {
    let crtc_info = xcb::randr::get_crtc_info(connection, *crtc, 0).get_reply()?;
    
    monitors.push(Monitor {
        x: crtc_info.x(),
        y: crtc_info.y(),
        width: crtc_info.width(),
        height: crtc_info.height(),
    });
}

// User selects area spanning monitors:
// Capture entire bounding box, then composite
```

---

### 3.3 Clipboard Manager

**File:** `src/clipboard.rs`

**Architecture:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Clipboard Manager                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Clipboard Operations (Arboard)       â”‚ â”‚
â”‚  â”‚                                        â”‚ â”‚
â”‚  â”‚  â€¢ set_image(ImageData)               â”‚ â”‚
â”‚  â”‚  â€¢ set_text(String)                   â”‚ â”‚
â”‚  â”‚  â€¢ get_image() -> ImageData           â”‚ â”‚
â”‚  â”‚  â€¢ get_text() -> String               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Monitoring Thread                    â”‚ â”‚
â”‚  â”‚                                        â”‚ â”‚
â”‚  â”‚  loop:                                 â”‚ â”‚
â”‚  â”‚    â€¢ Poll clipboard every 500ms       â”‚ â”‚
â”‚  â”‚    â€¢ Detect changes (hash compare)    â”‚ â”‚
â”‚  â”‚    â€¢ Store new content to DB          â”‚ â”‚
â”‚  â”‚    â€¢ Update last_content cache        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Deduplication Logic                  â”‚ â”‚
â”‚  â”‚                                        â”‚ â”‚
â”‚  â”‚  â€¢ Hash text content (SHA256)         â”‚ â”‚
â”‚  â”‚  â€¢ Hash image bytes (SHA256)          â”‚ â”‚
â”‚  â”‚  â€¢ Compare with previous hash         â”‚ â”‚
â”‚  â”‚  â€¢ Skip if duplicate                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Data Flow: Clipboard Monitoring**

```
Background Thread Loop
         â”‚
         â”‚ (every 500ms)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Try Get Text      â”‚
â”‚  from Clipboard    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â”‚                       â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚  Calculate Hash    â”‚
         â”‚              â”‚  of text content   â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚  Compare with      â”‚
         â”‚              â”‚  last_text_hash    â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â”œâ”€ Different â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                 â”‚
         â”‚                       â”‚                 â–¼
         â”‚                       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚        â”‚ Store Text in  â”‚
         â”‚                       â”‚        â”‚ Database       â”‚
         â”‚                       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                 â”‚
         â”‚                       â”‚                 â–¼
         â”‚                       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚        â”‚ Update Cache   â”‚
         â”‚                       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â””â”€ Same â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                         â”‚
         â””â”€ Failure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                   â”‚
                                                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Try Get Image     â”‚
â”‚  from Clipboard    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â”‚                       â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚  Calculate Hash    â”‚
         â”‚              â”‚  of image bytes    â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚  Compare with      â”‚
         â”‚              â”‚  last_image_hash   â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â”œâ”€ Different â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                 â”‚
         â”‚                       â”‚                 â–¼
         â”‚                       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚        â”‚ Convert to PNG â”‚
         â”‚                       â”‚        â”‚ if needed      â”‚
         â”‚                       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                 â”‚
         â”‚                       â”‚                 â–¼
         â”‚                       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚        â”‚ Generate       â”‚
         â”‚                       â”‚        â”‚ Thumbnail      â”‚
         â”‚                       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                 â”‚
         â”‚                       â”‚                 â–¼
         â”‚                       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚        â”‚ Store Image    â”‚
         â”‚                       â”‚        â”‚ in Database    â”‚
         â”‚                       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                 â”‚
         â”‚                       â”‚                 â–¼
         â”‚                       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚        â”‚ Update Cache   â”‚
         â”‚                       â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â””â”€ Same â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                         â”‚
         â””â”€ Failure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                   â”‚
                                                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sleep 500ms       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â”€ (loop back to start)
```

**Clipboard Ownership:**

When this tool copies to clipboard, it becomes the **clipboard owner**. Other applications request clipboard data through X11 `SelectionRequest` events.

```rust
// Simplified ownership model (handled by Arboard)
clipboard.set_image(image_data);
// â†’ Daemon now owns CLIPBOARD selection
// â†’ Must respond to SelectionRequest events
// â†’ Arboard handles this automatically
```

---

### 3.4 Database Layer

**File:** `src/database.rs`

**Schema Design:**

```sql
-- Main table for all clipboard history
CREATE TABLE clipboard_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content_type TEXT NOT NULL,           -- 'text' or 'image'
    content_data BLOB,                    -- PNG bytes (images only)
    text_content TEXT,                    -- UTF-8 text (text only)
    thumbnail BLOB,                       -- 150x150 PNG thumbnail (images)
    created_at INTEGER NOT NULL,          -- Unix timestamp (seconds)
    file_size INTEGER,                    -- Size in bytes
    metadata TEXT,                        -- JSON for future extensions
    
    CHECK (
        (content_type = 'image' AND content_data IS NOT NULL) OR
        (content_type = 'text' AND text_content IS NOT NULL)
    )
);

-- Indexes for performance
CREATE INDEX idx_created_at ON clipboard_history(created_at DESC);
CREATE INDEX idx_content_type ON clipboard_history(content_type);
CREATE INDEX idx_text_search ON clipboard_history(text_content);
```

**Query Patterns:**

```rust
// Insert image
conn.execute(
    "INSERT INTO clipboard_history 
     (content_type, content_data, thumbnail, created_at, file_size)
     VALUES (?1, ?2, ?3, ?4, ?5)",
    params!["image", png_bytes, thumb_bytes, now(), png_bytes.len()],
)?;

// Insert text
conn.execute(
    "INSERT INTO clipboard_history 
     (content_type, text_content, created_at, file_size)
     VALUES (?1, ?2, ?3, ?4)",
    params!["text", text, now(), text.len()],
)?;

// Get recent entries (mixed)
let mut stmt = conn.prepare(
    "SELECT id, content_type, content_data, text_content, 
            thumbnail, created_at, file_size
     FROM clipboard_history
     ORDER BY created_at DESC
     LIMIT ?1"
)?;

// Search text entries
let mut stmt = conn.prepare(
    "SELECT id, text_content, created_at
     FROM clipboard_history
     WHERE content_type = 'text' 
       AND text_content LIKE ?1
     ORDER BY created_at DESC
     LIMIT 50"
)?;

// Cleanup old entries (retention policy)
conn.execute(
    "DELETE FROM clipboard_history
     WHERE created_at < ?1",
    params![cutoff_timestamp],
)?;

// Vacuum database periodically (reclaim space)
conn.execute("VACUUM", [])?;
```

**Database Operations Architecture:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Database Layer                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Connection Pool (Single Thread)  â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚  â€¢ One SQLite connection           â”‚ â”‚
â”‚  â”‚  â€¢ Mutex-protected access          â”‚ â”‚
â”‚  â”‚  â€¢ Connection reuse                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   CRUD Operations                  â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚  â€¢ insert_image()                  â”‚ â”‚
â”‚  â”‚  â€¢ insert_text()                   â”‚ â”‚
â”‚  â”‚  â€¢ get_recent_entries()            â”‚ â”‚
â”‚  â”‚  â€¢ search_text()                   â”‚ â”‚
â”‚  â”‚  â€¢ delete_entry()                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Maintenance                      â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚  â€¢ cleanup_old_entries()           â”‚ â”‚
â”‚  â”‚  â€¢ vacuum_database()               â”‚ â”‚
â”‚  â”‚  â€¢ check_integrity()               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Transaction Management           â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚  â€¢ BEGIN/COMMIT/ROLLBACK           â”‚ â”‚
â”‚  â”‚  â€¢ Error recovery                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Storage Estimates:**

| Content Type | Size per Entry | 500 Entries | 1000 Entries |
|--------------|----------------|-------------|--------------|
| Text (avg 500 chars) | ~0.5 KB | ~250 KB | ~500 KB |
| Screenshot (1080p PNG) | ~500 KB | ~250 MB | ~500 MB |
| Thumbnail (150x150) | ~20 KB | ~10 MB | ~20 MB |
| **Worst Case (all screenshots)** | **~520 KB** | **~260 MB** | **~520 MB** |

**Database File Location:**
- Default: `~/.config/clipboard-capture/history.db`
- Configurable via `config.toml`

---

### 3.5 History Dialog (UI)

**File:** `src/ui/history_dialog.rs`

**GTK Widget Hierarchy:**

```
ApplicationWindow ("Clipboard History")
â””â”€â”€ Box (Vertical, spacing=6)
    â”œâ”€â”€ Entry (Search)
    â”‚   â””â”€â”€ "Search clipboard..."
    â”‚
    â”œâ”€â”€ ScrolledWindow (vexpand=true)
    â”‚   â””â”€â”€ FlowBox (max_children_per_line=4)
    â”‚       â”œâ”€â”€ Box (Vertical) [Image Entry 1]
    â”‚       â”‚   â”œâ”€â”€ Image (thumbnail)
    â”‚       â”‚   â””â”€â”€ Label (timestamp)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ Box (Vertical) [Text Entry 2]
    â”‚       â”‚   â”œâ”€â”€ Label (text preview)
    â”‚       â”‚   â””â”€â”€ Label (timestamp)
    â”‚       â”‚
    â”‚       â””â”€â”€ ... (more entries)
    â”‚
    â””â”€â”€ Box (Horizontal) [Status Bar]
        â””â”€â”€ Label ("50 items")
```

**UI Layout:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Clipboard History                     [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ” Search clipboard...                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ [IMG] â”‚ â”‚ Text  â”‚ â”‚ [IMG] â”‚ â”‚ More  â”‚   â”‚
â”‚ â”‚       â”‚ â”‚ lorem â”‚ â”‚       â”‚ â”‚ text  â”‚   â”‚
â”‚ â”‚ 150px â”‚ â”‚ ipsum â”‚ â”‚ 150px â”‚ â”‚ here  â”‚   â”‚
â”‚ â”‚       â”‚ â”‚ ...   â”‚ â”‚       â”‚ â”‚ ...   â”‚   â”‚
â”‚ â”‚ 2m agoâ”‚ â”‚ 5m agoâ”‚ â”‚ 10m   â”‚ â”‚ 15m   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ [IMG] â”‚ â”‚ Text  â”‚ â”‚ [IMG] â”‚ â”‚ [IMG] â”‚   â”‚
â”‚ â”‚       â”‚ â”‚ code  â”‚ â”‚       â”‚ â”‚       â”‚   â”‚
â”‚ â”‚ 150px â”‚ â”‚ snip  â”‚ â”‚ 150px â”‚ â”‚ 150px â”‚   â”‚
â”‚ â”‚       â”‚ â”‚ ...   â”‚ â”‚       â”‚ â”‚       â”‚   â”‚
â”‚ â”‚ 1h agoâ”‚ â”‚ 2h agoâ”‚ â”‚ 3h agoâ”‚ â”‚ 4h agoâ”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚                                         â–²   â”‚
â”‚                                         â–ˆ   â”‚
â”‚                                         â–¼   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 50 items                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Event Handling:**

```
User Opens Dialog (Win+H)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create GTK Window â”‚
â”‚  if not exists     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Query Database    â”‚
â”‚  for recent 50     â”‚
â”‚  entries           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Populate FlowBox  â”‚
â”‚  with entries      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Present Window    â”‚
â”‚  (bring to front)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€ User Types in Search â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                      â”‚
         â”‚                                      â–¼
         â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚  Filter Entries    â”‚
         â”‚                            â”‚  based on query    â”‚
         â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                     â”‚
         â”‚                                     â–¼
         â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚  Re-populate       â”‚
         â”‚                            â”‚  FlowBox           â”‚
         â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€ User Clicks Entry â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚
         â”‚                                    â–¼
         â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                          â”‚  Get Entry from DB â”‚
         â”‚                          â”‚  (full data)       â”‚
         â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â”‚                                   â–¼
         â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                          â”‚  Copy to Clipboard â”‚
         â”‚                          â”‚  (set_image/text)  â”‚
         â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â”‚                                   â–¼
         â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                          â”‚  Show Notification â”‚
         â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â”‚                                   â–¼
         â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                          â”‚  Close Window      â”‚
         â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€ User Presses ESC â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚
                                            â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚  Close Window      â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3.6 Global Hotkey Manager

**File:** `src/hotkeys.rs`

**Architecture:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Hotkey Manager                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  GlobalHotKeyManager               â”‚ â”‚
â”‚  â”‚  (global-hotkey crate)             â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚  Registers with X11 display        â”‚ â”‚
â”‚  â”‚  Grabs key combinations globally   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Registered Hotkeys                â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚  â€¢ Ctrl+Super+S â†’ Screenshot       â”‚ â”‚
â”‚  â”‚  â€¢ Super+H â†’ History Dialog        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Event Receiver                    â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚  Receives HotKeyEvent from channel â”‚ â”‚
â”‚  â”‚  Dispatches to registered callback â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Config Parser                     â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚  "Ctrl+Super+S" â†’ HotKey struct    â”‚ â”‚
â”‚  â”‚  Supports: Ctrl, Alt, Shift, Super â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Event Flow:**

```
User Presses Ctrl+Win+S
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  X11 XGrabKey      â”‚
â”‚  detects keypress  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  global-hotkey     â”‚
â”‚  library receives  â”‚
â”‚  event             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Send HotKeyEvent  â”‚
â”‚  to channel        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Daemon receives   â”‚
â”‚  from channel      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Match on hotkey   â”‚
â”‚  ID                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Screenshot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â”‚                       â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ Start Screenshot   â”‚
         â”‚              â”‚ Module             â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ Open History       â”‚
                       â”‚ Dialog             â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Data Models

### 4.1 Core Data Structures

```rust
// Configuration
#[derive(Debug, Deserialize, Serialize)]
pub struct Config {
    pub shortcuts: Shortcuts,
    pub capture: CaptureConfig,
    pub history: HistoryConfig,
    pub storage: StorageConfig,
    pub ui: UiConfig,
    pub privacy: PrivacyConfig,
}

#[derive(Debug, Deserialize, Serialize)]
pub struct Shortcuts {
    pub screenshot: String,  // "Ctrl+Super+S"
    pub history: String,     // "Super+H"
}

// History Entry
#[derive(Debug, Clone)]
pub enum ContentType {
    Image,
    Text,
}

#[derive(Debug, Clone)]
pub struct HistoryEntry {
    pub id: i64,
    pub content_type: ContentType,
    pub image_data: Option<Vec<u8>>,      // Full PNG
    pub thumbnail: Option<Vec<u8>>,        // 150x150 PNG
    pub text_content: Option<String>,      // UTF-8 text
    pub created_at: i64,                   // Unix timestamp
    pub file_size: usize,                  // Bytes
}

// Screenshot Rectangle
#[derive(Debug, Clone, Copy)]
pub struct Rectangle {
    pub x: i16,
    pub y: i16,
    pub width: u16,
    pub height: u16,
}

// Monitor Info
#[derive(Debug, Clone)]
pub struct Monitor {
    pub id: u32,
    pub x: i16,
    pub y: i16,
    pub width: u16,
    pub height: u16,
    pub scale: f64,  // HiDPI scale factor
}
```

### 4.2 Error Types

```rust
use thiserror::Error;

#[derive(Error, Debug)]
pub enum ClipboardCaptureError {
    #[error("X11 connection failed: {0}")]
    X11Error(String),
    
    #[error("Database error: {0}")]
    DatabaseError(#[from] rusqlite::Error),
    
    #[error("Image processing error: {0}")]
    ImageError(#[from] image::ImageError),
    
    #[error("Clipboard error: {0}")]
    ClipboardError(String),
    
    #[error("Config error: {0}")]
    ConfigError(#[from] toml::de::Error),
    
    #[error("IO error: {0}")]
    IoError(#[from] std::io::Error),
    
    #[error("Hotkey registration failed: {0}")]
    HotkeyError(String),
}
```

---

## 5. Inter-Component Communication

### 5.1 Message Passing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HotkeyEvent      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Hotkey    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚   Main      â”‚
â”‚   Manager   â”‚      (channel)       â”‚   Daemon    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ spawn task
                                            â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚ Screenshot  â”‚
                                     â”‚   Module    â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ PNG bytes
                                            â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Clipboard  â”‚
                                     â”‚   Manager   â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ store
                                            â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Database   â”‚
                                     â”‚             â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Shared State

**Thread-Safe Shared Data:**

```rust
pub struct AppState {
    pub config: Arc<RwLock<Config>>,
    pub database: Arc<Mutex<Database>>,
    pub clipboard: Arc<Mutex<ClipboardManager>>,
    pub screenshot: Arc<Mutex<ScreenshotCapture>>,
}
```

**Access Patterns:**

- **Config:** Read-heavy, write-rare (RwLock)
- **Database:** Exclusive access needed (Mutex)
- **Clipboard:** Exclusive access needed (Mutex)
- **Screenshot:** Exclusive access during capture (Mutex)

---

## 6. Performance Considerations

### 6.1 Latency Targets

| Operation | Target | Worst Case |
|-----------|--------|------------|
| Hotkey detection | < 50ms | < 100ms |
| Overlay window creation | < 200ms | < 500ms |
| Screen capture | < 300ms | < 1000ms |
| PNG encoding | < 200ms | < 500ms |
| Database insert | < 50ms | < 100ms |
| History dialog open | < 200ms | < 500ms |
| Search query | < 50ms | < 100ms |

### 6.2 Memory Usage

**Idle State:** ~30-50 MB
- Daemon binary: ~10-15 MB
- GTK libraries: ~15-20 MB
- Database cache: ~5-10 MB
- Working memory: ~5-10 MB

**Active Capture:** +20-50 MB
- Screenshot buffer: ~8 MB (1080p RGBA)
- PNG encoding buffer: ~2-5 MB
- Thumbnail generation: ~1 MB

**History Dialog Open:** +10-30 MB
- Widget tree: ~5-10 MB
- Thumbnail cache: ~5-20 MB (depends on entries)

### 6.3 Optimization Strategies

1. **Lazy Loading**
   - Load thumbnails on-demand in history dialog
   - Don't load full images until needed

2. **Image Compression**
   - Use PNG compression level 6 (balanced)
   - Generate thumbnails immediately (don't store full size twice)

3. **Database Indexing**
   - Index on `created_at` for recent queries
   - Index on `text_content` for search

4. **Async Operations**
   - PNG encoding in background task
   - Database writes in background
   - Clipboard monitoring in separate thread

5. **Resource Pooling**
   - Reuse X11 connection
   - Keep GTK widgets in memory
   - Connection pool for database (if needed)

---

## 7. Security & Privacy

### 7.1 Threat Model

**Threats:**
- Unauthorized access to clipboard history (local user)
- Malicious applications reading clipboard
- SQL injection via clipboard content
- Memory dumps containing sensitive data

**Mitigations:**
- File permissions: 600 on database file
- Prepared statements: No SQL injection
- Memory clearing: Overwrite sensitive data on exit (future)
- Encryption at rest: Optional feature (future)

### 7.2 Privacy Controls

**Config Options:**
```toml
[privacy]
exclude_passwords = true          # Don't store password manager clipboard
retention_days = 7                # Auto-delete old entries
max_entries = 500                 # Limit history size
```

**Implementation:**
```rust
fn should_store_clipboard(content: &str) -> bool {
    // Don't store if it looks like a password
    if config.privacy.exclude_passwords {
        if is_password_like(content) {
            return false;
        }
    }
    true
}

fn is_password_like(text: &str) -> bool {
    // Heuristics:
    // - Length 8-64 chars
    // - No whitespace
    // - Mix of alphanumeric + symbols
    text.len() >= 8 && text.len() <= 64
        && !text.contains(' ')
        && text.chars().any(|c| c.is_alphanumeric())
        && text.chars().any(|c| !c.is_alphanumeric())
}
```

---

## 8. Error Handling & Recovery

### 8.1 Error Handling Strategy

**Principles:**
1. Never panic in production code
2. Log all errors with context
3. Recover gracefully when possible
4. Show user-friendly error messages

**Example:**
```rust
async fn handle_screenshot_hotkey() -> Result<()> {
    // Layer 1: X11 connection
    let screenshot = ScreenshotCapture::new()
        .map_err(|e| {
            error!("Failed to connect to X11: {}", e);
            notify_screenshot_error("Could not access display");
            e
        })?;
    
    // Layer 2: User selection
    let rect = screenshot.select_area()
        .await
        .map_err(|e| {
            error!("Selection failed: {}", e);
            notify_screenshot_error("Selection cancelled");
            e
        })?;
    
    // Layer 3: Capture
    let png_bytes = screenshot.capture_and_encode(rect)
        .await
        .map_err(|e| {
            error!("Capture failed: {}", e);
            notify_screenshot_error("Could not capture screen");
            e
        })?;
    
    // Layer 4: Clipboard
    clipboard.set_image(png_bytes)
        .map_err(|e| {
            error!("Clipboard failed: {}", e);
            notify_screenshot_error("Could not copy to clipboard");
            e
        })?;
    
    notify_screenshot_success();
    Ok(())
}
```

### 8.2 Recovery Mechanisms

| Failure | Recovery Strategy |
|---------|------------------|
| X11 disconnected | Retry connection, notify user |
| Database locked | Wait with exponential backoff |
| Out of memory | Clear caches, suggest cleanup |
| Clipboard unavailable | Retry, fallback to file save |
| Config file corrupt | Use defaults, recreate file |

---

## 9. Testing Strategy

### 9.1 Unit Tests

Test individual components in isolation:
- Config parsing
- Database CRUD operations
- Image encoding/decoding
- Hotkey parsing
- Rectangle calculations

### 9.2 Integration Tests

Test component interactions:
- Screenshot â†’ Clipboard â†’ Database
- Clipboard monitoring â†’ Database
- History dialog â†’ Database â†’ Clipboard
- Config changes â†’ Hotkey re-registration

### 9.3 Manual Test Scenarios

1. **Multi-Monitor Setup**
   - Selection spans monitors
   - Different DPI scales
   - Monitor disconnect/reconnect

2. **Clipboard Compatibility**
   - Paste in 20+ applications
   - Different MIME types
   - Large images (>10 MB)

3. **Long-Running Stability**
   - 24-hour continuous operation
   - Memory leak detection
   - 1000+ clipboard operations

4. **Edge Cases**
   - Empty clipboard
   - Very large text (1 MB+)
   - Special characters (emojis, unicode)
   - Rapid hotkey presses

---

## 10. Deployment Architecture

### 10.1 Installation Paths

```
/usr/bin/clipboard-capture-daemon    # Main executable
~/.config/clipboard-capture/
    â”œâ”€â”€ config.toml                  # User config
    â”œâ”€â”€ history.db                   # SQLite database
    â””â”€â”€ logs/
        â””â”€â”€ daemon.log               # Optional logs

/usr/share/applications/
    â””â”€â”€ clipboard-capture.desktop    # Desktop entry

/usr/share/icons/hicolor/
    â””â”€â”€ scalable/apps/
        â””â”€â”€ clipboard-capture.svg    # App icon

~/.config/systemd/user/
    â””â”€â”€ clipboard-capture.service    # Systemd service
```

### 10.2 Auto-Start

**Systemd User Service:**
```bash
systemctl --user enable clipboard-capture
systemctl --user start clipboard-capture
```

**Desktop Autostart (alternative):**
```desktop
[Desktop Entry]
Type=Application
Name=Clipboard Capture
Exec=/usr/bin/clipboard-capture-daemon
Hidden=true
NoDisplay=true
X-GNOME-Autostart-enabled=true
```

---

## 11. Future Architecture (Wayland)

### 11.1 Wayland Portals

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Clipboard Capture (Wayland Mode)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  org.freedesktop.portal.          â”‚ â”‚
â”‚  â”‚     Screenshot                    â”‚ â”‚
â”‚  â”‚                                   â”‚ â”‚
â”‚  â”‚  â€¢ User permission dialog         â”‚ â”‚
â”‚  â”‚  â€¢ Returns PipeWire stream        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  PipeWire Stream Processing       â”‚ â”‚
â”‚  â”‚                                   â”‚ â”‚
â”‚  â”‚  â€¢ Receive frame data             â”‚ â”‚
â”‚  â”‚  â€¢ Extract selected region        â”‚ â”‚
â”‚  â”‚  â€¢ Encode to PNG                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  wl_data_device (Clipboard)       â”‚ â”‚
â”‚  â”‚                                   â”‚ â”‚
â”‚  â”‚  â€¢ Set clipboard content          â”‚ â”‚
â”‚  â”‚  â€¢ Monitor clipboard changes      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Document End**
